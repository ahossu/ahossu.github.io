<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Arno (HackTheBox) — Android Unity IL2CPP Writeup</title>
    <meta name="description" content="Writeup for Arno (HackTheBox Android Unity IL2CPP challenge) by Alexandru Hossu">
    <meta property="og:title" content="Arno (HackTheBox) — Android Unity IL2CPP Writeup" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta name="twitter:card" content="summary" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/jpeg" href="../avatar.jpg">

    <style>
      :root {
        --bg: #121212;
        --fg: #e0e0e0;
        --accent: #61dafb;
        --border: #333;
        --muted: #a0a0a0;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: 'Work Sans', sans-serif;
        line-height: 1.6;
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover { text-decoration: underline; }

      .wrapper {
        max-width: 768px;
        margin: 0 auto;
        padding: 2rem 1rem 3rem;
      }

      .site-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 3rem;
      }
      .site-title {
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--fg);
      }
      .site-logo {
        height: 48px;
        width: 48px;
        border-radius: 50%;
        object-fit: cover;
      }

      .post {
        max-width: 768px;
        margin: 0 auto;
      }

      .post-header h1 {
        margin: 0 0 0.5rem;
        font-size: 2rem;
        font-weight: 500;
      }

      .post-subtitle {
        margin: 0 0 0.75rem;
        opacity: 0.8;
        font-size: 1rem;
      }

      .post-meta {
        margin: 0 0 1.5rem;
        font-size: 0.9rem;
        color: var(--muted);
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: 0.4rem;
      }
      .tag {
        font-size: 0.75rem;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.02);
      }

      .post-toc {
        margin: 2rem 0;
        padding: 1rem 1.25rem;
        border-radius: 0.75rem;
        border: 1px solid var(--border);
        background: #181818;
      }
      .post-toc-title {
        margin: 0 0 0.5rem;
        font-size: 0.95rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        opacity: 0.8;
      }
      .post-toc ul {
        margin: 0;
        padding-left: 1.25rem;
        font-size: 0.95rem;
      }
      .post-toc li {
        margin: 0.1rem 0;
      }

      section + section {
        margin-top: 2rem;
      }
      h2 {
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      h3 {
        font-size: 1.15rem;
        margin-bottom: 0.4rem;
        font-weight: 500;
      }

      p {
        margin: 0 0 0.9rem;
      }

      ul, ol {
        padding-left: 1.25rem;
        margin-top: 0;
        margin-bottom: 0.9rem;
      }

      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.9rem;
        background: rgba(255,255,255,0.04);
        padding: 0.15rem 0.3rem;
        border-radius: 0.25rem;
      }

      pre {
        margin: 0 0 1.25rem;
        padding: 0.85rem 1rem;
        background: #0b0b0b;
        border-radius: 0.5rem;
        border: 1px solid #1f1f1f;
        overflow-x: auto;
      }
      pre code {
        background: transparent;
        padding: 0;
      }

      .note {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border);
        background: #181818;
        font-size: 0.92rem;
        margin-bottom: 1rem;
      }

      .back-link {
        margin: 0 0 2rem;
        font-size: 0.95rem;
      }

      .site-footer {
        border-top: 1px solid var(--border);
        margin-top: 3rem;
        padding-top: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .site-footer p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">

      <header class="site-header">
        <a href="/" class="site-title">Alexandru Hossu</a>
        <img src="../avatar.jpg" alt="Logo" class="site-logo">
      </header>

      <article class="post">
        <p class="back-link">
          ← <a href="index.html">Back to all writeups</a>
        </p>

        <header class="post-header">
          <h1>Arno (HackTheBox) — Android Unity IL2CPP</h1>
          <p class="post-subtitle">
            Classic Unity IL2CPP flow: grab the APK, dump <code>libil2cpp.so</code> +
            <code>global-metadata.dat</code>, find key / IV / ciphertext, then let Python do the rest.
          </p>
          <p class="post-meta">
            <span>Reverse Engineering / Android</span>
            <span>HackTheBox Challenge</span>
          </p>
          <div class="post-tags">
            <span class="tag">Unity</span>
            <span class="tag">IL2CPP</span>
            <span class="tag">AES-CBC</span>
            <span class="tag">Android</span>
          </div>
        </header>

        <nav class="post-toc">
          <p class="post-toc-title">On this page</p>
          <ul>
            <li><a href="#context">0. Context</a></li>
            <li><a href="#apk-decompilation">1. Decompiling the APK</a></li>
            <li><a href="#il2cppdumper">2. Running Il2CppDumper</a></li>
            <li><a href="#ilspy">3. Quick C# view with ilspycmd</a></li>
            <li><a href="#ida">4. IDA Pro + Il2CppDumper script</a></li>
            <li><a href="#metadata">5. Finding key / IV / flag in metadata</a></li>
            <li><a href="#decryptflag">6. Understanding <code>DecryptFlag</code></a></li>
            <li><a href="#python-script">7. Python decrypt script</a></li>
          </ul>
        </nav>

        <section id="context">
          <h2>0. Context</h2>
          <p>
            Challenge: <a href="https://app.hackthebox.com/challenges/Arno" target="_blank" rel="noopener noreferrer">
            Arno (HackTheBox)</a>. The only file you get is an Android app: <code>Arno.apk</code>.
          </p>
          <p>
            I was expecting some mobile reversing, but as soon as I looked inside the APK it screamed “Unity IL2CPP”.
          </p>
          <p>
            The basic idea:
          </p>
          <ol>
            <li>Confirm it’s Unity IL2CPP (not plain Mono C#).</li>
            <li>Use Il2CppDumper to get fake C# + mappings.</li>
            <li>Track where key, IV and encrypted flag are stored.</li>
            <li>Recreate the AES decrypt in Python and print the flag.</li>
          </ol>
        </section>

        <section id="apk-decompilation">
          <h2>1. Decompiling the APK</h2>
          <p>
            First step: unpack the APK with <code>apktool</code>.
          </p>

          <pre><code>apktool d Arno.apk -o app_dec</code></pre>

          <p>Then I checked the usual Unity IL2CPP locations:</p>

          <pre><code>app_dec/lib/arm64-v8a/libil2cpp.so
app_dec/assets/bin/Data/Managed/Metadata/global-metadata.dat</code></pre>

          <p>
            If you see both <code>libil2cpp.so</code> and <code>global-metadata.dat</code>, you’re in IL2CPP territory.
            No nice C# decompile for you, you have to go through the native side plus metadata.
          </p>
        </section>

        <section id="il2cppdumper">
          <h2>2. Running Il2CppDumper</h2>
          <p>
            With those two files found, the next step is Il2CppDumper. I had it in my <code>$PATH</code>, so I just ran:
          </p>

          <pre><code>il2cppdumper \
  app_dec/lib/arm64-v8a/libil2cpp.so \
  app_dec/assets/bin/Data/Managed/Metadata/global-metadata.dat \
  Arno_dump</code></pre>

          <p>It produced:</p>
          <ul>
            <li><code>dump.cs</code></li>
            <li><code>script.json</code></li>
            <li><code>il2cpp.h</code></li>
            <li><code>DummyDll/Assembly-CSharp.dll</code> and friends</li>
          </ul>

          <p>
            For this challenge, the important ones are:
          </p>
          <ul>
            <li><code>dump.cs</code> – all types / methods / fields in one huge C# file.</li>
            <li><code>DummyDll/Assembly-CSharp.dll</code> – for quick browsing with <code>ilspycmd</code>.</li>
            <li><code>script.json</code> + <code>il2cpp.h</code> – for IDA so that functions get proper names.</li>
          </ul>
        </section>

        <section id="ilspy">
          <h2>3. Quick C# view with ilspycmd</h2>
          <p>
            Before staring at ARM64 in IDA, I like to get a rough feel for the managed code.
          </p>
          <p>I dumped the dummy DLL with <code>ilspycmd</code>:</p>

          <pre><code>cd Arno_dump/DummyDll
ilspycmd -p Assembly-CSharp.dll -o src</code></pre>

          <p>Then searched for anything that smelled like “flag”:</p>

          <pre><code>grep -R "FlagControl" -n src
sed -n '1,200p' src/FlagControl.cs</code></pre>

          <p>
            <code>FlagControl</code> is exactly what you expect: Unity stuff for the UI, plus the interesting methods:
            <code>GetKey()</code>, <code>GetIV()</code>, <code>GetFlag()</code>, <code>DecryptFlag()</code>.
          </p>
          <p>
            The methods are tagged with attributes like
            <code>[Address(RVA = "0x16D1838", VA = "0x16D1838")]</code>, which makes it easy to line them up with the
            native side in IDA later.
          </p>
        </section>

        <section id="ida">
          <h2>4. IDA Pro + Il2CppDumper script</h2>
          <p>
            Next, I opened <code>libil2cpp.so</code> in IDA (ARM64). To get sane function names, I ran the Il2CppDumper
            script that comes with the tool:
          </p>

          <ol>
            <li>Open <code>libil2cpp.so</code> in IDA (64-bit ARM).</li>
            <li><code>File → Script file…</code> → select <code>ida_with_struct.py</code> (or similar).</li>
            <li>When prompted:
              <ul>
                <li><code>script.json</code> → <code>Arno_dump/script.json</code></li>
                <li><code>il2cpp.h</code> → <code>Arno_dump/il2cpp.h</code></li>
              </ul>
            </li>
          </ol>

          <p>
            After that finishes, IDA suddenly looks much friendlier: functions like
            <code>FlagControl__GetKey</code>, <code>FlagControl__GetIV</code>,
            <code>FlagControl__GetFlag</code>, <code>FlagControl__DecryptFlag</code> show up in the names list.
          </p>
        </section>

        <section id="metadata">
          <h2>5. Finding key / IV / flag in metadata</h2>
          <p>
            The app doesn’t hardcode the key/IV/flag as obvious byte arrays in the native code. Instead, they’re stored
            in <code>global-metadata.dat</code> under the usual <code>&lt;PrivateImplementationDetails&gt;</code>
            umbrella.
          </p>

          <h3>5.1. <code>&lt;PrivateImplementationDetails&gt;</code> in <code>dump.cs</code></h3>

          <p>
            At the end of <code>dump.cs</code> I searched for
            <code>PrivateImplementationDetails</code>:
          </p>

          <pre><code>grep -n "PrivateImplementationDetails" dump.cs</code></pre>

          <p>There are a bunch of lines like:</p>

          <pre><code>private struct &lt;PrivateImplementationDetails&gt;.__StaticArrayInitTypeSize=16 { ... }
private struct &lt;PrivateImplementationDetails&gt;.__StaticArrayInitTypeSize=32 { ... }
...

internal static readonly &lt;PrivateImplementationDetails&gt;.__StaticArrayInitTypeSize=38 2694... /*Metadata offset 0x3EBA20*/; // 0x0
internal static readonly &lt;PrivateImplementationDetails&gt;.__StaticArrayInitTypeSize=16 36CB... /*Metadata offset 0x3EBA48*/; // 0x26
internal static readonly &lt;PrivateImplementationDetails&gt;.__StaticArrayInitTypeSize=17 4356... /*Metadata offset 0x3EBA60*/; // 0x36
internal static readonly &lt;PrivateImplementationDetails&gt;.__StaticArrayInitTypeSize=48 6F30... /*Metadata offset 0x3EBA78*/; // 0x47
internal static readonly &lt;PrivateImplementationDetails&gt;.__StaticArrayInitTypeSize=32 703A... /*Metadata offset 0x3EBAB0*/; // 0x77</code></pre>

          <p>
            Each line gives you:
          </p>
          <ul>
            <li>the size of the array (16, 32, 48, ...),</li>
            <li>a hash-like name,</li>
            <li>and a metadata offset inside <code>global-metadata.dat</code>.</li>
          </ul>

          <p>
            From IDA, you can see which of these fields each of <code>GetKey</code>, <code>GetIV</code> and
            <code>GetFlag</code> uses.
          </p>

          <p>
            For Arno, it ended up like this for me:
          </p>
          <ul>
            <li><strong>Key</strong>: 32 bytes → offset <code>0x3EBAB0</code></li>
            <li><strong>IV</strong>: 16 bytes → offset <code>0x3EBA48</code></li>
            <li><strong>Encrypted flag</strong>: 48 bytes → offset <code>0x3EBA78</code></li>
          </ul>

          <h3>5.2. Extracting the bytes with <code>xxd</code></h3>

          <p>
            With the offsets known, I went into the metadata directory and used <code>xxd</code> to slice the bytes
            straight out of <code>global-metadata.dat</code>:
          </p>

          <pre><code>cd app_dec/assets/bin/Data/Managed/Metadata

# KEY (32 bytes)
xxd -s 0x3EBAB0 -l 0x20 global-metadata.dat

# IV (16 bytes)
xxd -s 0x3EBA48 -l 0x10 global-metadata.dat

# FLAG ciphertext (48 bytes)
xxd -s 0x3EBA78 -l 0x30 global-metadata.dat</code></pre>

          <p>
            After cleaning the output into plain hex strings (no spaces, no offsets), I had:
          </p>

          <pre><code>key_hex = "cfdc33ccbee6dc775ba146b95d0fea6cbcc3ee3e5e76531d2cd79c140758f08d"
iv_hex  = "bbf5a8d7066fd51b43d959c044365cdf"
ct_hex  = "13ebf3953a9b8c13c6e5471f7eeaa0174b6c1fac41802002da16eb32fa88f63c570185a8bc218d9ef3ac03e218d30c55"</code></pre>
        </section>

        <section id="decryptflag">
          <h2>6. Understanding <code>DecryptFlag</code> in IDA</h2>
          <p>
            The last missing piece is how the app actually decrypts the flag. That’s all in
            <code>FlagControl__DecryptFlag</code>.
          </p>
          <p>
            Following the calls in IDA, you can spot the usual suspects:
          </p>

          <ul>
            <li><code>Aes.Create()</code> (or the IL2CPP equivalent)</li>
            <li>Key and IV being set from <code>GetKey()</code> / <code>GetIV()</code></li>
            <li><code>MemoryStream</code> + <code>CryptoStream</code> in decrypt mode</li>
            <li>Finally, <code>Encoding.UTF8.GetString(...)</code> on the decrypted bytes</li>
          </ul>

          <p>
            So nothing fancy: AES-CBC with PKCS7 padding, output is a UTF-8 string (the flag).
            That’s easy to re-create in Python.
          </p>
        </section>

        <section id="python-script">
          <h2>7. Python script to decrypt the flag</h2>

          <div class="note">
            Here’s the script I used. It only depends on <code>pycryptodome</code>. The hex values are the ones
            extracted with <code>xxd</code> earlier.
          </div>

          <pre><code>from Crypto.Cipher import AES
from binascii import unhexlify

key_hex = "cfdc33ccbee6dc775ba146b95d0fea6cbcc3ee3e5e76531d2cd79c140758f08d"
iv_hex  = "bbf5a8d7066fd51b43d959c044365cdf"
ct_hex  = "13ebf3953a9b8c13c6e5471f7eeaa0174b6c1fac41802002da16eb32fa88f63c570185a8bc218d9ef3ac03e218d30c55"

key = unhexlify(key_hex)
iv = unhexlify(iv_hex)
ct = unhexlify(ct_hex)

cipher = AES.new(key, AES.MODE_CBC, iv)
pt = cipher.decrypt(ct)

# strip PKCS7 padding
pad_len = pt[-1]
flag = pt[:-pad_len].decode("utf-8")
print(flag)</code></pre>

          <p>
            Running this prints the flag in the expected <code>HTB{...}</code> format.
          </p>
        </section>

        <section>
          <h2>Wrap-up</h2>
          <p>
            Arno is basically a “template” Unity IL2CPP Android challenge:
          </p>
          <ul>
            <li>Spot <code>libil2cpp.so</code> + <code>global-metadata.dat</code> inside the APK.</li>
            <li>Use Il2CppDumper to get both native mappings and a fake C# view.</li>
            <li>Let IDA name the interesting functions for you.</li>
            <li>Map <code>&lt;PrivateImplementationDetails&gt;</code> fields to offsets in the metadata file.</li>
            <li>Rebuild the AES-CBC decryption logic in a script and recover the flag.</li>
          </ul>
          <p>
            After a couple of IL2CPP challenges like this, the workflow becomes pretty mechanical — which is nice,
            because you can then focus on the interesting variations instead of fighting the tooling every time.
          </p>
        </section>
      </article>

      <footer class="site-footer">
        <p>2025 © Alexandru Hossu</p>
      </footer>
    </div>
  </body>
</html>